(function(){var t,c=function(e,t){return function(){return e.apply(t,arguments)}};window.undefined_title=[],t=function(){function e(){var r,e,i,a,s,t,o,n;this.init_filter=c(this.init_filter,this),this.init_data_table=c(this.init_data_table,this),this.create_table=c(this.create_table,this),this.create_table_with_timeout=c(this.create_table_with_timeout,this),this.init_column_defs=c(this.init_column_defs,this),this.load_current_csv=c(this.load_current_csv,this),this.parse_csv=c(this.parse_csv,this),this.score_to_rank=c(this.score_to_rank,this),this.to_version_label=c(this.to_version_label,this),this.to_version_num=c(this.to_version_num,this),this.convert_title=c(this.convert_title,this),r=this,e=URI(location.href).search(!0),this.table=$("#score_table"),this.header=$(".filter_header .inner"),this.score_viewer=$(".filter_header, .table_container"),this.loading=$(".loading_message"),console.log("start",+new Date),window.notes_csv=this.notes_csv=this.parse_csv(notes_data),this.rank_names=["MIN","F","E","D","C","B","A","AA","AAA","MAX"],this.clear_types={"NO PLAY":"NO PLAY",FAILED:"FAILED","ASSIST CLEAR":"ASSIST","EASY CLEAR":"EASY",CLEAR:"CLEAR","HARD CLEAR":"HARD","EX HARD CLEAR":"EX HARD","FULLCOMBO CLEAR":"FULLCOMBO"},this.long_clear_types=_(this.clear_types).keys(),a=$(".score_tooltip"),$(document).on("mouseover","td.notes",function(){var n,e,t;return 9,t=2*parseInt($(this).text()),n=t/9,e=_(9).times(function(e){var t;return t=r.rank_names[e+1]+"："+Math.ceil(n*(e+1)),$("<div>").text(t)}),a.empty().append(e.reverse()),a.appendTo(this)}),i=["around","prev","next"],_(i).each(function(t,n){return $(document).on("contextmenu","th."+t+"_rank",function(){var e;return window.dt.column(t+"_rank:name").visible(!1),e=i[n+1]||i[0],window.dt.column(e+"_rank:name").visible(!0),!1})}),$(document).on("contextmenu","th",function(){return!1}),e.debug?(this.csv_name=e.csv,this.old_csv_name=e.old_csv,this.with_old=!!this.old_csv_name,this.with_old?$.ajax({url:"./csv/"+this.old_csv_name,success:(n=this,function(e){return n.old_csv_data=e,n.load_current_csv()})}):this.load_current_csv()):($("content").show(),s=$("label.view_score"),$(document).on("change","li input:file",(o=this,function(e){var t,n,r;return r=$(e.target),t=e.target.files[0],(n=new FileReader).onload=function(e){return r.closest("label").find(".button").text("["+t.name+"] selected"),r.is(".current_csv")?(o.csv_name=t.name,o.csv_data=e.target.result,$("input.old_csv").prop({disabled:!1}).closest("label").removeClass("disabled"),s.removeClass("disabled")):(o.old_csv_name=t.name,o.with_old=!0,o.old_csv_data=e.target.result)},n.readAsText(t)})).on("click","label.view_score",(t=this,function(){if(!s.is(".disabled"))return console.log("view start",+new Date),t.create_table_with_timeout()})))}return e.prototype.convert_title=function(e){return{"19，November":"19,November","Sweet Sweet Magic":"Sweet Sweet♥Magic","Raspberry Heart(English version)":"Raspberry♥Heart(English version)","ピアノ協奏曲第１番”蠍火”":'ピアノ協奏曲第1番"蠍火"',"ＵＬＴｉＭΛＴＥ":"ULTiM∧TE","100％ minimoo-G":"100% minimoo-G","Double Loving Heart":"Double♥♥Loving Heart","Blind Justice ～Torn souls， Hurt Faiths ～":"Blind Justice ～Torn souls, Hurt Faiths～","never…":"never...","花吹雪 ～ IIDX LIMITED ～":"花吹雪 ～IIDX LIMITED～",Ubertreffen:"Übertreffen","Punch Love 仮面":"Punch Love♡仮面","Raison d'etre～交差する宿命～":"Raison d'être～交差する宿命～","ワルツ第17番 ト短調”大犬のワルツ”":'ワルツ第17番 ト短調"大犬のワルツ"',"A MINSTREL ～ ver. short-scape ～":"A MINSTREL ～ver. short-scape～","恋する☆宇宙戦争っ！！":"恋する☆宇宙戦争っ!!","Light and Cyber…":"Light and Cyber･･･",Praludium:"Präludium","キャトられ恋はモ～モク":"キャトられ♥恋はモ～モク",ATHER:"ÆTHER",Atropos:"Atröpøs","Close the World feat. a☆ru":"Close the World feat.a☆ru","旋律のドグマ～Miserables～":"旋律のドグマ～Misérables～","超!!遠距離らぶメ～ル":"超!!遠距離らぶ♡メ～ル","超!!遠距離らぶ?メ～ル":"超!!遠距離らぶ♡メ～ル","表裏一体！？怪盗いいんちょの悩み":"表裏一体！？怪盗いいんちょの悩み♥","!Viva!":"¡Viva!","火影":"焱影","炎影":"焱影","Verflucht†LEGGENDARIA":"Verflucht †LEGGENDARIA","Amor De Verao":"Amor De Verão","草原の王女-軌跡を辿って-":"草原の王女-奇跡を辿って-","ROCK女 feat. 大山愛未， Ken":"ROCK女 feat. 大山愛未, Ken",Xlo:"Xlø"}[e]||e},e.prototype.to_version_num=function(e){var t;return void 0,0<=(t=["IIDX RED","HAPPY SKY","DistorteD","GOLD","DJ TROOPERS","EMPRESS","SIRIUS","Resort Anthem","Lincle","tricoro","SPADA","PENDUAL","copula","SINOBUZ","CANNON BALLERS","Rootage"]).indexOf(e)?t.indexOf(e)+11:e.match("\\d+")[0]},e.prototype.to_version_label=function(e){var t;return(t={"1st&substream":"1st&s","DJ TROOPERS":"TROOPERS"})[e]?t[e]:e.replace(" style","")},e.prototype.score_to_rank=function(t,e){var n,r,i;return n=2*e/9,r=_(9).times(function(e){return Math.ceil(n*(e+1))}),i=_(r).find(function(e){return t<=e}),this.rank_names[r.indexOf(i)]},e.prototype.parse_csv=function(e){return null==e&&(e=""),Papa.parse(e.trim().replace(/\u00A0/gm," ")).data},e.prototype.load_current_csv=function(){return $.ajax({url:"./csv/"+this.csv_name,success:(t=this,function(e){return console.log("loaded",+new Date),t.csv_data=e,t.create_table_with_timeout()})});var t},e.prototype.init_column_defs=function(){var e,r;return e=["desc","asc"],this.column_defs={version_number:{visible:!1},version:{orderSequence:e},title:{},difficulty:{},level:{orderSequence:e},notes:{orderSequence:e},score_diff:{visible:this.with_old,orderSequence:e},score_diff_filter:{visible:!1},score_bar:{sortable:!this.with_old,orderSequence:e},score_rate:{sortable:!this.with_old,orderSequence:e},score:{visible:!1},rank:{sortable:!this.with_old},rank_filter:{visible:!1},next_rank:{visible:!1,sortable:!this.with_old},prev_rank:{visible:!1,sortable:!this.with_old},around_rank:{sortable:!this.with_old},miss:{sortable:!this.with_old,orderSequence:e},miss_filter:{visible:!1},clear_type:{sortable:!this.with_old},clear_type_filter:{visible:!1},play_count:{sortable:!this.with_old,orderSequence:e},date:{sortable:!this.with_old,orderSequence:e}},_({version:"version_number",score_bar:"score"}).each((r=this,function(t,e){var n;return n=_(r.column_defs).chain().keys().findIndex(function(e){return e===t}).value(),r.column_defs[e].orderData=[n]}))},e.prototype.create_table_with_timeout=function(){return $("content").hide(),this.score_viewer.show().css({visibility:"hidden"}),this.loading.show(),setTimeout((e=this,function(){return e.create_table()}),100);var e},e.prototype.create_table=function(){var o,c,e,l,n,d,u,t,h,f,r,p,v,i,P;return this.with_old=!!this.with_old,$("body").toggleClass("with_old",this.with_old),this.init_column_defs(),window.csv=e=this.parse_csv(this.csv_data),t=this.old_csv=this.parse_csv(this.old_csv_data),v=this.table.find("thead"),p=this.table.find("tbody"),window.columns=[],h=l=null,n={},f={},c={"バージョン":"version","タイトル":"title","プレー回数":"play_count","最終プレー日時":"date"},o={},u={},d=_(e).min(function(e,t){return 0===t?"99999999":_.last(e)}),d=_.last(d),_(e).select(function(e){return _.last(e)===d}).length<=1&&(d=null),_(e).each((P=this,function(i,e){var r,T,a,M,s,H;return 0===e?(l=i,h=s=P.old_csv[e],_(["normal","hyper","another"]).each(function(t){return n[t]=_(i).findIndex(function(e){return e.match("^"+t.toUpperCase())}),f[t]=_(s).findIndex(function(e){return e.match("^"+t.toUpperCase())})}),_(i).each(function(e,t){var n;if(n=c[e])return o[n]=t}),_(s).each(function(e,t){var n;if(n=c[e])return u[n]=t}),H=$("<tr>").appendTo(v),_(P.column_defs).each(function(e,t){var n;return n={score_bar:"score",score_rate:"rate",score_diff:"score diff",clear_type:"clear",play_count:"play count",next_rank:"next rank",prev_rank:"prev rank",around_rank:"around rank",date:"last play",difficulty:"N,H,A",lavel:"LV"}[t]||t,H.append($("<th>").text(n))}),console.log(i)):(T=_(o).reduce(function(e,t,n){var r;switch(r=i[t],n){case"date":r=r===d?"":moment(r,"YYYY-MM-DD HH:mm").format("MM/DD HH:mm");break;case"title":e.original_title=r,r=P.convert_title(r)}return e[n]=r,e},{}),s=_(P.old_csv).find(function(e,t){return e[u.title]===T.original_title}),M=_(u).reduce(function(e,t,n){var r;if(s){switch(r=s[t],n){case"date":r=r===d?"":moment(r,"YYYY-MM-DD HH:mm").format("MM/DD HH:mm");break;case"title":r=P.convert_title(r)}e[n]=r}return e},{}),r={level:"難易度",score:"EXスコア",p_great:"PGreat",great:"Great",clear_type:"クリアタイプ",miss:"ミスカウント",rank:"DJ LEVEL"},a=-1,_(n).each(function(e,D){var E,R,S,O,t,n;if(E=D.toUpperCase(),a++,R=function(e){if(s)return s[h.indexOf(E+" "+r[e])]},"0"!==(S=function(e){return i[l.indexOf(E+" "+r[e])]})("level")&&(!P.with_old||0<parseInt(S("score"))&&0<parseInt(R("score"))))return H=$("<tr>").appendTo(p),(t=_.find(P.notes_csv,function(e){return e[0]===T.title}))||(n=T.title.replace(/ /g,"").toLowerCase(),t=_.find(P.notes_csv,function(e){return e[0].replace(/ /g,"").toLowerCase()===n})),O="not found",t?O=parseInt(t[a+1]):window.undefined_title.push(T.title),_(P.column_defs).each(function(e,t){var n,r,i,a,s,o,c,l,d,u,h,f,p,v,m,b,w,k,g,y,x,A,I,C,L;if(v=!1,I=$("<td>").appendTo(H),L=T[t],i=[],f=[],n={},h={},_.isUndefined(L))switch(C=S(t),_.isUndefined(C)||(L=C),w=R(t),_.isUndefined(w)||(k=w),t){case"miss":v=!0,"---"===L&&(L=""),parseInt(k)<0&&(k="");break;case"miss_filter":L=(u=parseInt(S("miss"))-parseInt(R("miss")))<0?"win":0<u?"lose":"even";break;case"difficulty":L=E.substr(0,1),i.push(D);break;case"next_rank":v=!0,L=k="",0<O&&(l=2*O/(A=9),d=_(A).times(function(e){return Math.ceil(l*(e+1))}),L=(a=function(e,t){var n,r,i;if(0<(i=parseInt(e("score"))))return r=_(d).find(function(e){return i<e}),n=P.rank_names[d.indexOf(r)+1],t.rank=n,i-r})(S,n),k=a(R,h));break;case"prev_rank":v=!0,L=k="",0<O&&(l=2*O/(A=9),d=_(A).times(function(e){return Math.ceil(l*(e+1))}),L=(a=function(e,t){var n,r,i;if(0<(i=parseInt(e("score"))))return r=_(d).find(function(e,t){return d[t+1]>i}),n=P.rank_names[d.indexOf(r)+1],t.rank=n,"+"+(i-r)})(S,n),k=a(R,h));break;case"around_rank":v=!0,L=k="",0<O&&(l=2*O/(A=9),d=_(A).times(function(e){return Math.ceil(l*(e+1))}),L=(a=function(e,t){var n,r,i,a,s,o;if(0<(o=parseInt(e("score"))))return a=_(d).find(function(e){return o<e}),s=d[d.indexOf(a)-1],r=o-s<a-o?s:a,i=P.rank_names[d.indexOf(r)+1],t.rank=i,(n=o-r)<0?n:"+"+n})(S,n),k=a(R,h));break;case"notes":L=O;break;case"score_rate":v=!0,(L=0)<(y=parseInt(S("score")))&&(L=y/(2*O)*100);break;case"score_bar":v=!0,I.attr({colspan:2}),_(["a","aa","aaa"]).each(function(e){return I.append($("<div>").addClass("line "+e))}),L=(s=function(e){var t,n,r;return r=e("score"),n=0,y=parseInt(r),t=P.header.find(".score_bar_container").clone(),0<y&&(n=y/(2*O)*100),_.isUndefined(r)?C=n="---":(C=r+"("+e("p_great")+"/"+e("great")+")",n="not found"===O?"---":n.toFixed(2),t.find(".bar").css({width:n+"%"})),t.find(".rate").text(n),t.find(".value").text(C),t})(S),k=s(R);break;case"score_diff":0<(L=parseInt(S("score"))-parseInt(R("score")))?L="+"+L:L<0&&i.push("minus");break;case"score_diff_filter":L=0<(x=parseInt(S("score"))-parseInt(R("score")))?"win":x<0?"lose":"even";break;case"clear_type":v=!0,L=P.clear_types[L]||"",k=P.clear_types[k]||"",i.push(L.replace(/ /g,"_").toLowerCase()),f.push(k.replace(/ /g,"_").toLowerCase());break;case"clear_type_filter":L=0<(r=P.long_clear_types.indexOf(S("clear_type"))-P.long_clear_types.indexOf(R("clear_type")))?"win":r<0?"lose":"even";break;case"version_number":L=P.to_version_num(T.version);break;case"rank":v=!0,y=parseInt(S("score")),0<(b=parseInt(R("score")))&&_.isEmpty(k)&&(k=P.score_to_rank(b,O)),L&&i.push(L.toLowerCase()),k&&f.push(k.toLowerCase());break;case"rank_filter":o=S("rank"),m=R("rank"),_.isEmpty(m)&&0<(b=parseInt(R("score")))&&(m=P.score_to_rank(b,O)),L=0<(g=P.rank_names.indexOf(o)-P.rank_names.indexOf(m))?"win":g<0?"lose":"even"}else switch(k=M[t],t){case"date":case"play_count":v=!0;break;case"version":L=P.to_version_label(L)}return v&&P.with_old?(I.addClass("no_padding"),c=$("<div>").addClass("inner").appendTo(I),p=$("<div>").addClass("old").appendTo(c).addClass(f.join(" ")).attr(h),$("<div>").addClass("split_line").appendTo(c),$("<div>").addClass("current").appendTo(c).addClass(i.join(" ")).attr(n).append(L),p.append(k)):I.append(L).addClass(i.join(" ")).attr(n)})}))})),i=_(e).last()[o.version],this.header.find(".current_file").text(this.csv_name+"("+i+")"),this.with_old&&(r=_(t).last()[o.version],this.header.find(".old_file").text(this.old_csv_name+"("+r+")")),this.init_data_table(),this.init_filter()},e.prototype.init_data_table=function(){var e;return console.log("ended",+new Date),e=!1,window.dt=this.table.DataTable({autoWidth:!1,pageLength:100,paging:!0,fixedHeader:{header:!0,footer:!0},columns:_(this.column_defs).map(function(e,t){return e.className=t,e.name=t,e}),drawCallback:function(){if(!e)return e=!0,setTimeout(function(){return $(window.dt.column("version:name").header()).click()},0)},order:[[1,"desc"]]}),window.dt.fixedHeader.headerOffset(this.header.closest(".filter_header").outerHeight()),this.loading.hide(),this.score_viewer.css({visibility:"visible"}).hide().fadeIn(),$("#score_table_paginate, #score_table_info").appendTo(this.header),console.log("notes data not found",undefined_title)},e.prototype.init_filter=function(){var r,f,p,e,t,v,n;return r={version:{},difficulty:{reverse:!0},level:{sort:"integer",reverse:!0},rank:{sort:this.rank_names},clear_type:{sort:_(this.clear_types).values()}},this.with_old&&(r.score_diff={target:"score_diff_filter"},r.rank={target:"rank_filter"},r.miss={target:"miss_filter"},r.clear_type={target:"clear_type_filter"}),_(r).each(function(e,t){var n;return(n=r[t]).target||(n.target=t)}),v=this.header.find(".checkbox"),n=this,f=function(e){var t;return(t=$($(".fixedHeader-floating")[0]||n.table[0]).find("th."+e)).addClass("filter_visible"),setTimeout(function(){return t.removeClass("filter_visible")},1)},p=function(c){return _(r).each(function(e,t){var n,r,i,a,s,o;if(o=e.target,n=window.dt.column(o+":name",{search:"applied"}),s=window.dt.column(t+":name",{search:"applied"}),!c||c.index()!==n.index())return i=n.search(),n.search(""),a=n.data(),r=_(a).countBy(),_($(s.header()).find(".check_container input")).each(function(e){var t;return e=$(e),t=r[$("<div>").text(e.val()).html()]||0,e.siblings("label").text(e.val()+" ("+t+")"),e.prop("disabled",0===t),e.parent().toggleClass("disabled",0===t)}),n.search(i,!0)})},e=$("input.search"),t=function(){return window.dt.column("title:name").search(e.val().trim()).draw(),p()},e.on("keyup",function(){return t()}),_(r).each(function(a,i){var s,o,c,l,e,t,n,d,u,r,h;return r=a.target,c=window.dt.column(r+":name"),n=window.dt.column(i+":name"),h=$(n.header()),l=v.clone(),o=l.find(".check_container"),s=l.find(".all input"),h.append(l),l.on("click",function(e){return e.stopPropagation()}),s.on("click",function(e){var t;return t=$(this).is(":checked"),o.find("input").prop({checked:t}),u()}),u=function(e){var t,n,r;return null==e&&(e=!0),t=_(o.find("input:checked")).map(function(e){return $(e).val().replace(" ","\\s")}),r=!!o.find("input:not(:checked)")[0],h.toggleClass("searched",r),s.prop({checked:!r}),n="^("+t.join("|")+")$",c.search(n,!0).draw(),f(i),p(c)},t=c.data(),e=_(t).chain().countBy().map(function(e,t){return{key:t,value:e}}),console.log(i,a),a.sort&&(e=e.sortBy(function(e){return"integer"===a.sort?parseInt(e.key):-a.sort.indexOf(e.key)})),e=e.value(),l=void 0,d=0,_(e).each(function(e){var t,n,r,i;return i=e.key,e.value,d%12==0&&(l=$("<div>"),o.append(l)),i=$("<div>").html(i).text(),t=$("<input>").attr({type:"checkbox",checked:!0,value:i}),r=$("<label>"),n=$("<div>").append(t).append(r),a.reverse?l.prepend(n):l.append(n),d++,r.on("click",function(){if(!$(this).closest(".disabled")[0])return t.prop({checked:!0}),o.find("input").not(t).prop({checked:!1}),u()}),t.on("change",function(){return u()})})}),p()},e}(),$(function(){return $.ajax({url:"csv/notes.csv",success:function(e){return window.notes_data=e,new t}})})}).call(this);